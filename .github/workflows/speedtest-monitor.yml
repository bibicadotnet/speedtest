name: Speedtest Server Monitor

on:
  schedule:
    # Cháº¡y hÃ ng ngÃ y lÃºc 2:00 UTC (9:00 AM GMT+7)
    - cron: '0 2 * * *'
  workflow_dispatch: # Cho phÃ©p cháº¡y thá»§ cÃ´ng

jobs:
  check-speedtest-servers:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install Speedtest CLI
      run: |
        curl -s https://packagecloud.io/install/repositories/ookla/speedtest-cli/script.deb.sh | sudo bash
        sudo apt-get install speedtest
        
    - name: Check and update server IDs
      run: |
        # Äá»c trá»±c tiáº¿p tá»« bench.sh Ä‘á»ƒ láº¥y danh sÃ¡ch server ID hiá»‡n táº¡i
        echo "ğŸ“Š Äá»c danh sÃ¡ch server tá»« bench.sh..."
        
        # Extract cÃ¡c dÃ²ng speed_test cÃ³ ID tá»« bench.sh
        mapfile -t server_lines < <(grep "speed_test '[0-9]" bench.sh)
        
        if [ ${#server_lines[@]} -eq 0 ]; then
          echo "âŒ KhÃ´ng tÃ¬m tháº¥y server nÃ o trong bench.sh"
          exit 1
        fi
        
        # Function tÃ¬m server thay tháº¿ dá»±a trÃªn location
        find_replacement_server() {
          local location="$1"
          local current_id="$2"
          
          echo "ğŸ” TÃ¬m server thay tháº¿ cho $location..."
          
          case "$location" in
            *"San Jose"*|*"US"*)
              speedtest --servers | grep -i "san jose\|california\|united states" | grep -v "$current_id" | head -1 | awk '{print $1}'
              ;;
            *"France"*|*"FR"*)
              speedtest --servers | grep -i "france\|paris" | grep -v "$current_id" | head -1 | awk '{print $1}'
              ;;
            *"Amsterdam"*|*"NL"*)
              speedtest --servers | grep -i "amsterdam\|netherlands" | grep -v "$current_id" | head -1 | awk '{print $1}'
              ;;
            *"Hong Kong"*|*"CN"*)
              speedtest --servers | grep -i "hong kong" | grep -v "$current_id" | head -1 | awk '{print $1}'
              ;;
            *"Singapore"*|*"SG"*)
              speedtest --servers | grep -i "singapore" | grep -v "$current_id" | head -1 | awk '{print $1}'
              ;;
            *"Tokyo"*|*"JP"*)
              speedtest --servers | grep -i "tokyo\|japan" | grep -v "$current_id" | head -1 | awk '{print $1}'
              ;;
            *"FPT"*"HCM"*|*"FPT"*"VN"*)
              speedtest --servers | grep -i "fpt.*ho chi minh\|fpt.*vietnam" | grep -v "$current_id" | head -1 | awk '{print $1}'
              ;;
            *"FPT"*"HN"*)
              speedtest --servers | grep -i "fpt.*hanoi\|fpt.*vietnam" | grep -v "$current_id" | head -1 | awk '{print $1}'
              ;;
            *"VNPT"*"HCM"*)
              speedtest --servers | grep -i "vnpt.*ho chi minh\|vnpt.*vietnam" | grep -v "$current_id" | head -1 | awk '{print $1}'
              ;;
            *"VNPT"*"HN"*)
              speedtest --servers | grep -i "vnpt.*hanoi\|vnpt.*vietnam" | grep -v "$current_id" | head -1 | awk '{print $1}'
              ;;
            *"Viettel"*"HCM"*)
              speedtest --servers | grep -i "viettel.*ho chi minh\|viettel.*vietnam" | grep -v "$current_id" | head -1 | awk '{print $1}'
              ;;
            *"Viettel"*"DN"*)
              speedtest --servers | grep -i "viettel.*da nang\|viettel.*vietnam" | grep -v "$current_id" | head -1 | awk '{print $1}'
              ;;
            *)
              # Fallback: tÃ¬m server báº¥t ká»³ á»Ÿ Vietnam náº¿u cÃ³ VN trong tÃªn
              if [[ "$location" == *"VN"* ]]; then
                speedtest --servers | grep -i "vietnam" | grep -v "$current_id" | head -1 | awk '{print $1}'
              fi
              ;;
          esac
        }
        
        CHANGED=false
        
        echo "ğŸ“Š Kiá»ƒm tra ${#server_lines[@]} speedtest servers..."
        echo "=================================="
        
        # Kiá»ƒm tra tá»«ng server
        for line in "${server_lines[@]}"; do
          # Extract server ID vÃ  location tá»« dÃ²ng
          # Format: speed_test '12345' 'Location Name'
          server_id=$(echo "$line" | sed -n "s/.*speed_test '\([0-9]*\)'.*/\1/p")
          location=$(echo "$line" | sed -n "s/.*speed_test '[0-9]*' '\([^']*\)'.*/\1/p")
          
          if [[ -z "$server_id" || -z "$location" ]]; then
            echo "âš ï¸ KhÃ´ng thá»ƒ parse: $line"
            continue
          fi
          
          echo "ğŸ§ª Kiá»ƒm tra Server $server_id ($location)"
          
          # Test server vá»›i timeout 30s
          if timeout 30 speedtest --server-id="$server_id" --accept-license --accept-gdpr > /dev/null 2>&1; then
            echo "âœ… Server $server_id OK"
          else
            echo "âŒ Server $server_id FAILED"
            
            # TÃ¬m server thay tháº¿
            new_server_id=$(find_replacement_server "$location" "$server_id")
            
            if [[ -n "$new_server_id" && "$new_server_id" != "$server_id" ]]; then
              # Test server má»›i
              echo "ğŸ”„ Test server thay tháº¿ $new_server_id..."
              if timeout 30 speedtest --server-id="$new_server_id" --accept-license --accept-gdpr > /dev/null 2>&1; then
                echo "âœ… Server $new_server_id OK - Thay tháº¿ $server_id"
                
                # Thay tháº¿ trá»±c tiáº¿p trong bench.sh
                sed -i "s/speed_test '$server_id'/speed_test '$new_server_id'/g" bench.sh
                
                CHANGED=true
                echo "ğŸ“ ÄÃ£ cáº­p nháº­t bench.sh: $server_id -> $new_server_id"
              else
                echo "âŒ Server thay tháº¿ $new_server_id cÅ©ng failed"
              fi
            else
              echo "âš ï¸ KhÃ´ng tÃ¬m tháº¥y server thay tháº¿ phÃ¹ há»£p cho $location"
            fi
          fi
          
          echo "---"
          sleep 3
        done
        
        echo "=================================="
        echo "CHANGED=$CHANGED" >> $GITHUB_ENV
        
    - name: Commit vÃ  push thay Ä‘á»•i
      if: env.CHANGED == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        echo "ğŸ“ Thay Ä‘á»•i trong bench.sh:"
        git diff bench.sh
        
        git add bench.sh
        git commit -m "ğŸ”„ Auto-update failed speedtest servers - $(date +'%Y-%m-%d %H:%M')"
        git push
