name: Speedtest Server Monitor

on:
  schedule:
    # Chạy hàng ngày lúc 2:00 UTC (9:00 AM GMT+7)
    - cron: '0 2 * * *'
  workflow_dispatch: # Cho phép chạy thủ công

jobs:
  check-speedtest-servers:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install Speedtest CLI
      run: |
        curl -s https://packagecloud.io/install/repositories/ookla/speedtest-cli/script.deb.sh | sudo bash
        sudo apt-get install speedtest
        
    - name: Check and update server IDs
      run: |
        # Đọc trực tiếp từ bench.sh để lấy danh sách server ID hiện tại
        echo "📊 Đọc danh sách server từ bench.sh..."
        
        # Extract các dòng speed_test có ID từ bench.sh
        mapfile -t server_lines < <(grep "speed_test '[0-9]" bench.sh)
        
        if [ ${#server_lines[@]} -eq 0 ]; then
          echo "❌ Không tìm thấy server nào trong bench.sh"
          exit 1
        fi
        
        # Function tìm server thay thế dựa trên location
        find_replacement_server() {
          local location="$1"
          local current_id="$2"
          
          echo "🔍 Tìm server thay thế cho $location..."
          
          case "$location" in
            *"San Jose"*|*"US"*)
              speedtest --servers | grep -i "san jose\|california\|united states" | grep -v "$current_id" | head -1 | awk '{print $1}'
              ;;
            *"France"*|*"FR"*)
              speedtest --servers | grep -i "france\|paris" | grep -v "$current_id" | head -1 | awk '{print $1}'
              ;;
            *"Amsterdam"*|*"NL"*)
              speedtest --servers | grep -i "amsterdam\|netherlands" | grep -v "$current_id" | head -1 | awk '{print $1}'
              ;;
            *"Hong Kong"*|*"CN"*)
              speedtest --servers | grep -i "hong kong" | grep -v "$current_id" | head -1 | awk '{print $1}'
              ;;
            *"Singapore"*|*"SG"*)
              speedtest --servers | grep -i "singapore" | grep -v "$current_id" | head -1 | awk '{print $1}'
              ;;
            *"Tokyo"*|*"JP"*)
              speedtest --servers | grep -i "tokyo\|japan" | grep -v "$current_id" | head -1 | awk '{print $1}'
              ;;
            *"FPT"*"HCM"*|*"FPT"*"VN"*)
              speedtest --servers | grep -i "fpt.*ho chi minh\|fpt.*vietnam" | grep -v "$current_id" | head -1 | awk '{print $1}'
              ;;
            *"FPT"*"HN"*)
              speedtest --servers | grep -i "fpt.*hanoi\|fpt.*vietnam" | grep -v "$current_id" | head -1 | awk '{print $1}'
              ;;
            *"VNPT"*"HCM"*)
              speedtest --servers | grep -i "vnpt.*ho chi minh\|vnpt.*vietnam" | grep -v "$current_id" | head -1 | awk '{print $1}'
              ;;
            *"VNPT"*"HN"*)
              speedtest --servers | grep -i "vnpt.*hanoi\|vnpt.*vietnam" | grep -v "$current_id" | head -1 | awk '{print $1}'
              ;;
            *"Viettel"*"HCM"*)
              speedtest --servers | grep -i "viettel.*ho chi minh\|viettel.*vietnam" | grep -v "$current_id" | head -1 | awk '{print $1}'
              ;;
            *"Viettel"*"DN"*)
              speedtest --servers | grep -i "viettel.*da nang\|viettel.*vietnam" | grep -v "$current_id" | head -1 | awk '{print $1}'
              ;;
            *)
              # Fallback: tìm server bất kỳ ở Vietnam nếu có VN trong tên
              if [[ "$location" == *"VN"* ]]; then
                speedtest --servers | grep -i "vietnam" | grep -v "$current_id" | head -1 | awk '{print $1}'
              fi
              ;;
          esac
        }
        
        CHANGED=false
        
        echo "📊 Kiểm tra ${#server_lines[@]} speedtest servers..."
        echo "=================================="
        
        # Kiểm tra từng server
        for line in "${server_lines[@]}"; do
          # Extract server ID và location từ dòng
          # Format: speed_test '12345' 'Location Name'
          server_id=$(echo "$line" | sed -n "s/.*speed_test '\([0-9]*\)'.*/\1/p")
          location=$(echo "$line" | sed -n "s/.*speed_test '[0-9]*' '\([^']*\)'.*/\1/p")
          
          if [[ -z "$server_id" || -z "$location" ]]; then
            echo "⚠️ Không thể parse: $line"
            continue
          fi
          
          echo "🧪 Kiểm tra Server $server_id ($location)"
          
          # Test server với timeout 30s
          if timeout 30 speedtest --server-id="$server_id" --accept-license --accept-gdpr > /dev/null 2>&1; then
            echo "✅ Server $server_id OK"
          else
            echo "❌ Server $server_id FAILED"
            
            # Tìm server thay thế
            new_server_id=$(find_replacement_server "$location" "$server_id")
            
            if [[ -n "$new_server_id" && "$new_server_id" != "$server_id" ]]; then
              # Test server mới
              echo "🔄 Test server thay thế $new_server_id..."
              if timeout 30 speedtest --server-id="$new_server_id" --accept-license --accept-gdpr > /dev/null 2>&1; then
                echo "✅ Server $new_server_id OK - Thay thế $server_id"
                
                # Thay thế trực tiếp trong bench.sh
                sed -i "s/speed_test '$server_id'/speed_test '$new_server_id'/g" bench.sh
                
                CHANGED=true
                echo "📝 Đã cập nhật bench.sh: $server_id -> $new_server_id"
              else
                echo "❌ Server thay thế $new_server_id cũng failed"
              fi
            else
              echo "⚠️ Không tìm thấy server thay thế phù hợp cho $location"
            fi
          fi
          
          echo "---"
          sleep 3
        done
        
        echo "=================================="
        echo "CHANGED=$CHANGED" >> $GITHUB_ENV
        
    - name: Commit và push thay đổi
      if: env.CHANGED == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        echo "📝 Thay đổi trong bench.sh:"
        git diff bench.sh
        
        git add bench.sh
        git commit -m "🔄 Auto-update failed speedtest servers - $(date +'%Y-%m-%d %H:%M')"
        git push
