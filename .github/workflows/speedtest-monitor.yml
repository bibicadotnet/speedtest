name: Speedtest Server Monitor

on:
  schedule:
    # Cháº¡y hÃ ng ngÃ y lÃºc 2:00 UTC (9:00 AM GMT+7)
    - cron: '0 2 * * *'
  workflow_dispatch: # Cho phÃ©p cháº¡y thá»§ cÃ´ng

jobs:
  check-speedtest-servers:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install Speedtest CLI
      run: |
        curl -s https://packagecloud.io/install/repositories/ookla/speedtest-cli/script.deb.sh | sudo bash
        sudo apt-get install speedtest-cli
        
    - name: Check and update server IDs
      run: |
        # Äá»c trá»±c tiáº¿p tá»« bench.sh Ä‘á»ƒ láº¥y danh sÃ¡ch server ID hiá»‡n táº¡i
        echo "ğŸ“Š Äá»c danh sÃ¡ch server tá»« bench.sh..."
        
        # Extract cÃ¡c dÃ²ng speed_test cÃ³ ID tá»« bench.sh
        mapfile -t server_lines < <(grep "speed_test '[0-9]" bench.sh)
        
        if [ ${#server_lines[@]} -eq 0 ]; then
          echo "âŒ KhÃ´ng tÃ¬m tháº¥y server nÃ o trong bench.sh"
          exit 1
        fi
        
        # Function test server vá»›i retry logic
        test_server_with_retry() {
          local server_id="$1"
          local max_attempts=3
          local timeout_duration=60
          
          for attempt in $(seq 1 $max_attempts); do
            echo "ğŸ”„ Attempt $attempt/$max_attempts for server $server_id"
            
            # Test vá»›i timeout dÃ i hÆ¡n vÃ  chá»‰ láº¥y ping test (nhanh hÆ¡n)
            if timeout $timeout_duration speedtest-cli --server="$server_id" --no-download --no-upload > /dev/null 2>&1; then
              echo "âœ… Server $server_id responded successfully on attempt $attempt"
              return 0
            else
              echo "âš ï¸ Server $server_id failed attempt $attempt"
              if [ $attempt -lt $max_attempts ]; then
                echo "â³ Waiting 10 seconds before retry..."
                sleep 10
              fi
            fi
          done
          
          echo "âŒ Server $server_id failed all $max_attempts attempts"
          return 1
        }
        
        # Function tÃ¬m server thay tháº¿ dá»±a trÃªn location
        find_replacement_server() {
          local location="$1"
          local current_id="$2"
          
          local new_id=""
          
          case "$location" in
            *"San Jose"*|*"US"*)
              new_id=$(speedtest-cli --list | grep -i "san jose\|california\|united states" | grep -v "$current_id" | head -3 | tail -1 | awk '{print $1}' | tr -d ')' | tr -d ' ')
              ;;
            *"France"*|*"FR"*)
              new_id=$(speedtest-cli --list | grep -i "france\|paris" | grep -v "$current_id" | head -3 | tail -1 | awk '{print $1}' | tr -d ')' | tr -d ' ')
              ;;
            *"Amsterdam"*|*"NL"*)
              new_id=$(speedtest-cli --list | grep -i "amsterdam\|netherlands" | grep -v "$current_id" | head -3 | tail -1 | awk '{print $1}' | tr -d ')' | tr -d ' ')
              ;;
            *"Hong Kong"*|*"CN"*)
              new_id=$(speedtest-cli --list | grep -i "hong kong" | grep -v "$current_id" | head -3 | tail -1 | awk '{print $1}' | tr -d ')' | tr -d ' ')
              ;;
            *"Singapore"*|*"SG"*)
              new_id=$(speedtest-cli --list | grep -i "singapore" | grep -v "$current_id" | head -3 | tail -1 | awk '{print $1}' | tr -d ')' | tr -d ' ')
              ;;
            *"Tokyo"*|*"JP"*)
              new_id=$(speedtest-cli --list | grep -i "tokyo\|japan" | grep -v "$current_id" | head -3 | tail -1 | awk '{print $1}' | tr -d ')' | tr -d ' ')
              ;;
            *"FPT"*"HCM"*|*"FPT"*"VN"*)
              new_id=$(speedtest-cli --list | grep -i "fpt.*ho chi minh\|fpt.*vietnam" | grep -v "$current_id" | head -3 | tail -1 | awk '{print $1}' | tr -d ')' | tr -d ' ')
              ;;
            *"FPT"*"HN"*)
              new_id=$(speedtest-cli --list | grep -i "fpt.*hanoi\|fpt.*vietnam" | grep -v "$current_id" | head -3 | tail -1 | awk '{print $1}' | tr -d ')' | tr -d ' ')
              ;;
            *"VNPT"*"HCM"*)
              new_id=$(speedtest-cli --list | grep -i "vnpt.*ho chi minh\|vnpt.*vietnam" | grep -v "$current_id" | head -3 | tail -1 | awk '{print $1}' | tr -d ')' | tr -d ' ')
              ;;
            *"VNPT"*"HN"*)
              new_id=$(speedtest-cli --list | grep -i "vnpt.*hanoi\|vnpt.*vietnam" | grep -v "$current_id" | head -3 | tail -1 | awk '{print $1}' | tr -d ')' | tr -d ' ')
              ;;
            *"Viettel"*"HCM"*)
              new_id=$(speedtest-cli --list | grep -i "viettel.*ho chi minh\|viettel.*vietnam" | grep -v "$current_id" | head -3 | tail -1 | awk '{print $1}' | tr -d ')' | tr -d ' ')
              ;;
            *"Viettel"*"DN"*)
              new_id=$(speedtest-cli --list | grep -i "viettel.*da nang\|viettel.*vietnam" | grep -v "$current_id" | head -3 | tail -1 | awk '{print $1}' | tr -d ')' | tr -d ' ')
              ;;
            *)
              # Fallback: tÃ¬m server báº¥t ká»³ á»Ÿ Vietnam náº¿u cÃ³ VN trong tÃªn
              if [[ "$location" == *"VN"* ]]; then
                new_id=$(speedtest-cli --list | grep -i "vietnam" | grep -v "$current_id" | head -3 | tail -1 | awk '{print $1}' | tr -d ')' | tr -d ' ')
              fi
              ;;
          esac
          
          # Chá»‰ return náº¿u new_id lÃ  sá»‘
          if [[ "$new_id" =~ ^[0-9]+$ ]]; then
            echo "$new_id"
          fi
        }
        
        CHANGED=false
        FAILED_SERVERS=()
        
        echo "ğŸ“Š Kiá»ƒm tra ${#server_lines[@]} speedtest servers..."
        echo "=================================="
        
        # Kiá»ƒm tra tá»«ng server
        for line in "${server_lines[@]}"; do
          # Extract server ID vÃ  location tá»« dÃ²ng
          # Format: speed_test '12345' 'Location Name'
          server_id=$(echo "$line" | sed -n "s/.*speed_test '\([0-9]*\)'.*/\1/p")
          location=$(echo "$line" | sed -n "s/.*speed_test '[0-9]*' '\([^']*\)'.*/\1/p")
          
          if [[ -z "$server_id" || -z "$location" ]]; then
            echo "âš ï¸ KhÃ´ng thá»ƒ parse: $line"
            continue
          fi
          
          echo "ğŸ§ª Kiá»ƒm tra Server $server_id ($location)"
          
          # Test server vá»›i retry logic
          if test_server_with_retry "$server_id"; then
            echo "âœ… Server $server_id OK"
          else
            echo "âŒ Server $server_id FAILED sau táº¥t cáº£ attempts"
            FAILED_SERVERS+=("$server_id:$location")
            
            echo "ğŸ” TÃ¬m server thay tháº¿ cho $location..."
            # TÃ¬m server thay tháº¿
            new_server_id=$(find_replacement_server "$location" "$server_id")
            
            if [[ -n "$new_server_id" && "$new_server_id" != "$server_id" ]]; then
              # Test server má»›i vá»›i retry
              echo "ğŸ”„ Test server thay tháº¿ $new_server_id..."
              if test_server_with_retry "$new_server_id"; then
                echo "âœ… Server $new_server_id OK - Thay tháº¿ $server_id"
                
                # Thay tháº¿ trá»±c tiáº¿p trong bench.sh (escape Ä‘áº·c biá»‡t characters)
                sed -i "s/speed_test '$server_id'/speed_test '$new_server_id'/g" bench.sh
                
                CHANGED=true
                echo "ğŸ“ ÄÃ£ cáº­p nháº­t bench.sh: $server_id -> $new_server_id"
              else
                echo "âŒ Server thay tháº¿ $new_server_id cÅ©ng failed"
              fi
            else
              echo "âš ï¸ KhÃ´ng tÃ¬m tháº¥y server thay tháº¿ phÃ¹ há»£p cho $location"
            fi
          fi
          
          echo "---"
          # TÄƒng delay giá»¯a cÃ¡c test Ä‘á»ƒ trÃ¡nh rate limiting
          sleep 5
        done
        
        echo "=================================="
        echo "ğŸ“Š Tá»•ng káº¿t:"
        echo "- Sá»‘ server failed: ${#FAILED_SERVERS[@]}"
        
        if [ ${#FAILED_SERVERS[@]} -gt 0 ]; then
          echo "- Danh sÃ¡ch server failed:"
          for failed in "${FAILED_SERVERS[@]}"; do
            echo "  * $failed"
          done
        fi
        
        # Chá»‰ commit náº¿u thá»±c sá»± cÃ³ thay Ä‘á»•i vÃ  sá»‘ server failed khÃ´ng quÃ¡ nhiá»u
        if [ ${#FAILED_SERVERS[@]} -gt 8 ]; then
          echo "âš ï¸ QuÃ¡ nhiá»u server failed (${#FAILED_SERVERS[@]}), cÃ³ thá»ƒ lÃ  network issue. KhÃ´ng thá»±c hiá»‡n thay Ä‘á»•i."
          CHANGED=false
        fi
        
        echo "CHANGED=$CHANGED" >> $GITHUB_ENV
        
    - name: Commit vÃ  push thay Ä‘á»•i
      if: env.CHANGED == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        echo "ğŸ“ Thay Ä‘á»•i trong bench.sh:"
        git diff bench.sh
        
        git add bench.sh
        git commit -m "ğŸ”„ Auto-update failed speedtest servers - $(date +'%Y-%m-%d %H:%M')"
        git push
