name: Speedtest Server Monitor

on:
  schedule:
    # Cháº¡y hÃ ng tuáº§n thay vÃ¬ hÃ ng ngÃ y Ä‘á»ƒ trÃ¡nh spam
    - cron: '0 2 * * 0'  # Chá»§ nháº­t lÃºc 2:00 UTC
  workflow_dispatch: # Cho phÃ©p cháº¡y thá»§ cÃ´ng

jobs:
  check-speedtest-servers:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        # CÃ i Ä‘áº·t speedtest-cli tá»« pip thay vÃ¬ apt (version má»›i hÆ¡n)
        sudo apt-get update
        sudo apt-get install -y python3-pip curl jq
        pip3 install speedtest-cli
        
        # ThÃªm pip bin vÃ o PATH
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        
    - name: Setup network optimization
      run: |
        # Thay Ä‘á»•i User-Agent vÃ  network settings
        export SPEEDTEST_CLI_USER_AGENT="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36"
        echo "SPEEDTEST_CLI_USER_AGENT=$SPEEDTEST_CLI_USER_AGENT" >> $GITHUB_ENV
        
        # Random delay Ä‘á»ƒ trÃ¡nh detection
        sleep $((RANDOM % 30 + 10))
        
    - name: Check servers availability
      run: |
        # Äá»c danh sÃ¡ch server tá»« bench.sh
        echo "ğŸ“Š Äá»c danh sÃ¡ch server tá»« bench.sh..."
        
        mapfile -t server_lines < <(grep "speed_test '[0-9]" bench.sh)
        
        if [ ${#server_lines[@]} -eq 0 ]; then
          echo "âŒ KhÃ´ng tÃ¬m tháº¥y server nÃ o trong bench.sh"
          exit 1
        fi
        
        # Function test server báº±ng speedtest-cli thá»±c táº¿
        check_server_exists() {
          local server_id="$1"
          
          echo "ğŸ” Testing server $server_id vá»›i speedtest-cli..."
          
          # Method 1: Sá»­ dá»¥ng speedtest-cli Ä‘á»ƒ test thá»±c táº¿ server
          local speedtest_output
          local exit_code
          
          # Timeout sau 30 giÃ¢y Ä‘á»ƒ trÃ¡nh hang
          timeout 30s speedtest-cli --server "$server_id" --no-download --no-upload --simple 2>/dev/null || exit_code=$?
          
          if [ $exit_code -eq 0 ]; then
            echo "âœ… Server $server_id responded to speedtest-cli"
            return 0
          fi
          
          # Method 2: Kiá»ƒm tra server cÃ³ trong danh sÃ¡ch servers cá»§a speedtest
          echo "ğŸ” Checking if server $server_id exists in server list..."
          local server_list
          server_list=$(timeout 20s speedtest-cli --list 2>/dev/null | grep -E "^\s*$server_id\)" || echo "")
          
          if [[ -n "$server_list" ]]; then
            echo "âœ… Server $server_id found in server list: $server_list"
            return 0
          fi
          
          # Method 3: Kiá»ƒm tra qua Speedtest API (backup method)
          echo "ğŸ” Checking server $server_id via Speedtest API..."
          local api_response
          api_response=$(curl -s --connect-timeout 10 --max-time 15 \
            -H "User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36" \
            "https://www.speedtest.net/api/js/servers?engine=js&limit=100" 2>/dev/null || echo "")
          
          if [[ "$api_response" == *"\"id\":$server_id"* || "$api_response" == *"\"id\":\"$server_id\""* ]]; then
            echo "âœ… Server $server_id found in API response"
            return 0
          fi
          
          echo "âŒ Server $server_id not found or not responding"
          return 1
        }
        
        # Function tÃ¬m server thay tháº¿ báº±ng cÃ¡ch query speedtest-cli
        find_replacement_server() {
          local location="$1"
          local current_id="$2"
          
          echo "ğŸ” TÃ¬m server thay tháº¿ cho $location..."
          
          # Láº¥y danh sÃ¡ch server tá»« speedtest-cli
          local server_list
          server_list=$(timeout 30s speedtest-cli --list 2>/dev/null || echo "")
          
          if [[ -z "$server_list" ]]; then
            echo "âš ï¸ KhÃ´ng thá»ƒ láº¥y danh sÃ¡ch server tá»« speedtest-cli"
            return 1
          fi
          
          # TÃ¬m server dá»±a trÃªn location keywords
          local search_patterns=()
          
          case "$location" in
            *"San Jose"*|*"US"*|*"United States"*) 
              search_patterns=("San Jose" "California" "US" "United States") ;;
            *"France"*|*"FR"*)
              search_patterns=("France" "Paris" "FR") ;;
            *"Amsterdam"*|*"Netherlands"*|*"NL"*)
              search_patterns=("Amsterdam" "Netherlands" "NL") ;;
            *"Hong Kong"*|*"HK"*)
              search_patterns=("Hong Kong" "HK") ;;
            *"Singapore"*|*"SG"*)
              search_patterns=("Singapore" "SG") ;;
            *"Tokyo"*|*"Japan"*|*"JP"*)
              search_patterns=("Tokyo" "Japan" "JP") ;;
            *"FPT"*|*"VNPT"*|*"Viettel"*|*"Vietnam"*|*"VN"*)
              search_patterns=("Vietnam" "VN" "FPT" "VNPT" "Viettel" "Ho Chi Minh" "Hanoi") ;;
            *)
              search_patterns=("Vietnam" "VN") ;;
          esac
          
          # TÃ¬m server match vá»›i pattern
          local candidate_servers=()
          
          for pattern in "${search_patterns[@]}"; do
            while IFS= read -r line; do
              if [[ "$line" =~ ^[[:space:]]*([0-9]+)\)[[:space:]]*(.+)$ ]]; then
                local found_id="${BASH_REMATCH[1]}"
                local found_desc="${BASH_REMATCH[2]}"
                
                if [[ "$found_id" != "$current_id" ]] && [[ "$found_desc" == *"$pattern"* ]]; then
                  candidate_servers+=("$found_id")
                  echo "ğŸ¯ Found candidate: $found_id - $found_desc"
                fi
              fi
            done <<< "$server_list"
            
            # Náº¿u Ä‘Ã£ tÃ¬m tháº¥y candidates, test chÃºng
            if [ ${#candidate_servers[@]} -gt 0 ]; then
              break
            fi
          done
          
          # Test cÃ¡c candidate servers
          for candidate_id in "${candidate_servers[@]}"; do
            echo "ğŸ§ª Testing candidate server $candidate_id..."
            if check_server_exists "$candidate_id"; then
              echo "âœ… Found working replacement: $candidate_id"
              echo "$candidate_id"
              return 0
            fi
            sleep 2
          done
          
          echo "âŒ KhÃ´ng tÃ¬m tháº¥y server thay tháº¿ cho $location"
          return 1
        }
        
        CHANGED=false
        FAILED_SERVERS=()
        REPLACED_SERVERS=()
        
        echo "ğŸ“Š Kiá»ƒm tra ${#server_lines[@]} speedtest servers..."
        echo "=================================="
        
        # Kiá»ƒm tra tá»«ng server vá»›i random delay
        for line in "${server_lines[@]}"; do
          server_id=$(echo "$line" | sed -n "s/.*speed_test '\([0-9]*\)'.*/\1/p")
          location=$(echo "$line" | sed -n "s/.*speed_test '[0-9]*' '\([^']*\)'.*/\1/p")
          
          if [[ -z "$server_id" || -z "$location" ]]; then
            echo "âš ï¸ KhÃ´ng thá»ƒ parse: $line"
            continue
          fi
          
          echo "ğŸ§ª Kiá»ƒm tra Server $server_id ($location)"
          
          # Random delay Ä‘á»ƒ trÃ¡nh rate limiting
          sleep $((RANDOM % 5 + 3))
          
          if check_server_exists "$server_id"; then
            echo "âœ… Server $server_id OK"
          else
            echo "âŒ Server $server_id FAILED"
            FAILED_SERVERS+=("$server_id:$location")
            
            # TÃ¬m server thay tháº¿
            new_server_id=$(find_replacement_server "$location" "$server_id")
            
            if [[ -n "$new_server_id" && "$new_server_id" != "$server_id" ]]; then
              echo "âœ… TÃ¬m tháº¥y server thay tháº¿ $new_server_id cho $location"
              
              # Thay tháº¿ trong bench.sh
              sed -i "s/speed_test '$server_id'/speed_test '$new_server_id'/g" bench.sh
              
              CHANGED=true
              REPLACED_SERVERS+=("$server_id -> $new_server_id ($location)")
              echo "ğŸ“ ÄÃ£ cáº­p nháº­t bench.sh: $server_id -> $new_server_id"
            else
              echo "âš ï¸ KhÃ´ng tÃ¬m tháº¥y server thay tháº¿ cho $location"
            fi
          fi
          
          echo "---"
        done
        
        echo "=================================="
        echo "ğŸ“Š Tá»•ng káº¿t:"
        echo "- Sá»‘ server failed: ${#FAILED_SERVERS[@]}"
        echo "- Sá»‘ server replaced: ${#REPLACED_SERVERS[@]}"
        
        if [ ${#FAILED_SERVERS[@]} -gt 0 ]; then
          echo "ğŸ”´ Server failed:"
          for failed in "${FAILED_SERVERS[@]}"; do
            echo "  * $failed"
          done
        fi
        
        if [ ${#REPLACED_SERVERS[@]} -gt 0 ]; then
          echo "ğŸŸ¢ Server replaced:"
          for replaced in "${REPLACED_SERVERS[@]}"; do
            echo "  * $replaced"
          done
        fi
        
        # Safety check: khÃ´ng thay Ä‘á»•i náº¿u quÃ¡ nhiá»u server failed
        if [ ${#FAILED_SERVERS[@]} -gt 6 ]; then
          echo "âš ï¸ QuÃ¡ nhiá»u server failed (${#FAILED_SERVERS[@]}), cÃ³ thá»ƒ lÃ  network issue."
          echo "Chá»‰ thá»±c hiá»‡n thay Ä‘á»•i náº¿u cÃ³ Ã­t nháº¥t 1 server thay tháº¿ thÃ nh cÃ´ng."
          if [ ${#REPLACED_SERVERS[@]} -eq 0 ]; then
            CHANGED=false
            echo "âŒ KhÃ´ng cÃ³ server nÃ o Ä‘Æ°á»£c thay tháº¿ thÃ nh cÃ´ng, há»§y commit."
          fi
        fi
        
        echo "CHANGED=$CHANGED" >> $GITHUB_ENV
        
        # Táº¡o summary cho GitHub Actions
        {
          echo "## ğŸš€ Speedtest Server Check Results"
          echo ""
          echo "- **Failed servers:** ${#FAILED_SERVERS[@]}"
          echo "- **Replaced servers:** ${#REPLACED_SERVERS[@]}"
          echo "- **Changes made:** $CHANGED"
          echo ""
          if [ ${#REPLACED_SERVERS[@]} -gt 0 ]; then
            echo "### âœ… Successful Replacements:"
            for replaced in "${REPLACED_SERVERS[@]}"; do
              echo "- $replaced"
            done
          fi
        } >> $GITHUB_STEP_SUMMARY
        
    - name: Commit vÃ  push thay Ä‘á»•i
      if: env.CHANGED == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        echo "ğŸ“ Thay Ä‘á»•i trong bench.sh:"
        git diff bench.sh
        
        if git diff --quiet bench.sh; then
          echo "âš ï¸ KhÃ´ng cÃ³ thay Ä‘á»•i thá»±c táº¿ trong bench.sh"
          exit 0
        fi
        
        git add bench.sh
        git commit -m "ğŸ”„ Auto-update speedtest servers - $(date +'%Y-%m-%d %H:%M')"
        git push
        
        echo "âœ… ÄÃ£ commit vÃ  push thay Ä‘á»•i thÃ nh cÃ´ng!"
