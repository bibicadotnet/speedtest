name: Speedtest Server Monitor

on:
  schedule:
    # Chạy hàng tuần thay vì hàng ngày để tránh spam
    - cron: '0 2 * * 0'  # Chủ nhật lúc 2:00 UTC
  workflow_dispatch: # Cho phép chạy thủ công

jobs:
  check-speedtest-servers:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        # Cài đặt speedtest-cli từ pip thay vì apt (version mới hơn)
        sudo apt-get update
        sudo apt-get install -y python3-pip curl jq perl
        pip3 install speedtest-cli
        
        # Thêm pip bin vào PATH
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        
    - name: Setup network optimization
      run: |
        # Random delay để tránh detection
        sleep $((RANDOM % 30 + 10))
        
    - name: Check servers availability
      run: |
        # Đọc danh sách server từ bench.sh
        echo "Doc danh sach server tu bench.sh..."
        
        mapfile -t server_lines < <(grep "speed_test '[0-9]" bench.sh)
        
        if [ ${#server_lines[@]} -eq 0 ]; then
          echo "ERROR: Khong tim thay server nao trong bench.sh"
          exit 1
        fi
        
        # Function get full server list không giới hạn theo location - KHÔNG DÙNG NỮA
        # get_server_list() {
          echo "Getting complete global server list from speedtest-cli..."
          
          # Cách 1: Dùng --list với bypass location filtering
          local server_list
          server_list=$(timeout 90s speedtest-cli --list --secure 2>/dev/null || echo "")
          
          if [[ -n "$server_list" && $(echo "$server_list" | wc -l) -gt 100 ]]; then
            echo "$server_list"
            return 0
          fi
          
          # Cách 2: Bypass bằng cách không auto-select location
          echo "Trying alternative method to get full server list..."
          server_list=$(timeout 90s python3 -c "
import speedtest
try:
    s = speedtest.Speedtest()
    servers = s.get_servers()
    for distance in sorted(servers.keys()):
        for server in servers[distance]:
            print(f'{server[\"id\"]}) {server[\"sponsor\"]} ({server[\"name\"]}, {server[\"country\"]}) [{distance:.2f} km]')
except Exception as e:
    print('Error getting servers:', e)
" 2>/dev/null || echo "")
          
          if [[ -n "$server_list" ]]; then
            echo "$server_list"
            return 0
          fi
          
          echo ""
          return 1
        }
        
        # Function test server bằng cách ping URL trực tiếp
        check_server_exists() {
          local server_id="$1"
          
          echo "Testing server $server_id via direct URL ping..."
          
          # Speedtest server URLs có format: 
          # http://[server_id].speedtest.net/speedtest/upload.php
          local server_url="http://${server_id}.speedtest.net/speedtest/upload.php"
          
          # Test bằng curl với timeout ngắn
          if timeout 15s curl -s --connect-timeout 10 --max-time 15 \
              -H "User-Agent: Mozilla/5.0 (X11; Linux x86_64)" \
              --head "$server_url" >/dev/null 2>&1; then
            echo "SUCCESS: Server $server_id is alive"
            return 0
          fi
          
          # Test URL alternative
          server_url="https://${server_id}.speedtest.net/speedtest/upload.php"
          if timeout 15s curl -s --connect-timeout 10 --max-time 15 \
              -H "User-Agent: Mozilla/5.0 (X11; Linux x86_64)" \
              --head "$server_url" >/dev/null 2>&1; then
            echo "SUCCESS: Server $server_id is alive (HTTPS)"
            return 0
          fi
          
          echo "FAILED: Server $server_id is not responding"
          return 1
        }
        
        # Function tìm server thay thế cùng location
        find_replacement_server() {
          local location="$1"
          local current_id="$2"
          
          echo "Tim server thay the cho location: $location (excluding $current_id)..."
          
          # Lấy server list chỉ cho region cần thiết
          local region_servers
          case "$location" in
            *"San Jose"*|*"US"*|*"United States"*|*"California"*) 
              echo "Searching for US West Coast servers..."
              region_servers=$(timeout 30s speedtest-cli --list 2>/dev/null | grep -i -E "(San Jose|California|US|United States)" | head -20)
              ;;
            *"France"*|*"FR"*|*"Paris"*)
              echo "Searching for France servers..."
              region_servers=$(timeout 30s speedtest-cli --list 2>/dev/null | grep -i -E "(France|Paris|FR)" | head -20)
              ;;
            *"Amsterdam"*|*"Netherlands"*|*"NL"*)
              echo "Searching for Netherlands servers..."
              region_servers=$(timeout 30s speedtest-cli --list 2>/dev/null | grep -i -E "(Amsterdam|Netherlands|NL)" | head -20)
              ;;
            *"Hong Kong"*|*"HK"*)
              echo "Searching for Hong Kong servers..."
              region_servers=$(timeout 30s speedtest-cli --list 2>/dev/null | grep -i -E "(Hong Kong|HK)" | head -20)
              ;;
            *"Singapore"*|*"SG"*)
              echo "Searching for Singapore servers..."
              region_servers=$(timeout 30s speedtest-cli --list 2>/dev/null | grep -i -E "(Singapore|SG)" | head -20)
              ;;
            *"Tokyo"*|*"Japan"*|*"JP"*)
              echo "Searching for Japan servers..."
              region_servers=$(timeout 30s speedtest-cli --list 2>/dev/null | grep -i -E "(Tokyo|Japan|JP)" | head -20)
              ;;
            *"FPT"*|*"VNPT"*|*"Viettel"*|*"Vietnam"*|*"VN"*|*"HN"*|*"HCM"*)
              echo "Searching for Vietnam servers..."
              region_servers=$(timeout 30s speedtest-cli --list 2>/dev/null | grep -i -E "(Vietnam|VN|FPT|VNPT|Viettel|Ho Chi Minh|Hanoi)" | head -20)
              ;;
            *)
              echo "Searching for general servers..."
              region_servers=$(timeout 30s speedtest-cli --list 2>/dev/null | head -50)
              ;;
          esac
          
          if [[ -z "$region_servers" ]]; then
            echo "ERROR: Cannot get server list for region"
            return 1
          fi
          
          echo "Found region servers:"
          echo "$region_servers"
          
          # Parse và test từng server
          local candidate_servers=()
          while IFS= read -r line; do
            if [[ "$line" =~ ^[[:space:]]*([0-9]+)\) ]]; then
              local found_id="${BASH_REMATCH[1]}"
              if [[ "$found_id" != "$current_id" ]]; then
                candidate_servers+=("$found_id")
              fi
            fi
          done <<< "$region_servers"
          
          echo "Testing ${#candidate_servers[@]} candidate servers..."
          
          # Test từng candidate
          for candidate_id in "${candidate_servers[@]}"; do
            echo "Testing candidate server $candidate_id..."
            
            if check_server_exists "$candidate_id"; then
              echo "SUCCESS: Found working replacement: $candidate_id"
              echo "$candidate_id"
              return 0
            fi
            
            sleep 2
          done
          
          echo "ERROR: No working replacement server found for $location"
          return 1
        }
        
        # Get server list một lần để dùng chung - KHÔNG CẦN NỮA
        # SERVER_LIST=$(get_server_list)
        
        CHANGED=false
        FAILED_SERVERS=()
        REPLACED_SERVERS=()
        
        echo "Kiem tra ${#server_lines[@]} speedtest servers..."
        echo "=================================="
        
        # Kiểm tra từng server
        for line in "${server_lines[@]}"; do
          server_id=$(echo "$line" | sed -n "s/.*speed_test '\([0-9]*\)'.*/\1/p")
          location=$(echo "$line" | sed -n "s/.*speed_test '[0-9]*' '\([^']*\)'.*/\1/p")
          
          if [[ -z "$server_id" || -z "$location" ]]; then
            echo "WARNING: Cannot parse line: $line"
            continue
          fi
          
          echo "Kiem tra Server $server_id ($location)"
          
          # Random delay để tránh rate limiting
          sleep $((RANDOM % 5 + 3))
          
          if check_server_exists "$server_id"; then
            echo "OK: Server $server_id"
          else
            echo "FAILED: Server $server_id"
            FAILED_SERVERS+=("$server_id:$location")
            
            # Tìm server thay thế
            echo "Tim server thay the cho $location..."
            new_server_id=$(find_replacement_server "$location" "$server_id")
            
            # Validate new_server_id
            if [[ -n "$new_server_id" && "$new_server_id" =~ ^[0-9]+$ && "$new_server_id" != "$server_id" ]]; then
              echo "SUCCESS: Tim thay server thay the: $new_server_id cho $location"
              
              # Backup bench.sh
              cp bench.sh bench.sh.backup
              
              # Thay thế trong bench.sh
              perl -i -pe "s/speed_test '$server_id'/speed_test '$new_server_id'/g" bench.sh
              
              # Verify thay đổi
              if grep -q "speed_test '$new_server_id'" bench.sh && ! grep -q "speed_test '$server_id'" bench.sh; then
                CHANGED=true
                REPLACED_SERVERS+=("$server_id -> $new_server_id ($location)")
                echo "UPDATE: Da cap nhat bench.sh: $server_id -> $new_server_id"
                rm -f bench.sh.backup
              else
                echo "ERROR: Khong the cap nhat bench.sh, rollback..."
                mv bench.sh.backup bench.sh
              fi
            else
              echo "WARNING: Khong tim thay server thay the hop le cho $location"
            fi
          fi
          
          echo "---"
        done
        
        echo "=================================="
        echo "Tong ket:"
        echo "- So server failed: ${#FAILED_SERVERS[@]}"
        echo "- So server replaced: ${#REPLACED_SERVERS[@]}"
        echo "- Changed: $CHANGED"
        
        if [ ${#FAILED_SERVERS[@]} -gt 0 ]; then
          echo ""
          echo "Failed servers:"
          for failed in "${FAILED_SERVERS[@]}"; do
            echo "  * $failed"
          done
        fi
        
        if [ ${#REPLACED_SERVERS[@]} -gt 0 ]; then
          echo ""
          echo "Replaced servers:"
          for replaced in "${REPLACED_SERVERS[@]}"; do
            echo "  * $replaced"
          done
        fi
        
        # Safety check
        if [ ${#FAILED_SERVERS[@]} -gt 6 ]; then
          echo "WARNING: Too many servers failed (${#FAILED_SERVERS[@]}), possible network issue."
          if [ ${#REPLACED_SERVERS[@]} -eq 0 ]; then
            CHANGED=false
            echo "ERROR: No successful replacements, canceling commit."
          fi
        fi
        
        echo "CHANGED=$CHANGED" >> $GITHUB_ENV
        
        # Tạo summary cho GitHub Actions
        {
          echo "## Speedtest Server Check Results"
          echo ""
          echo "- **Failed servers:** ${#FAILED_SERVERS[@]}"
          echo "- **Replaced servers:** ${#REPLACED_SERVERS[@]}"
          echo "- **Changes made:** $CHANGED"
          echo ""
          if [ ${#REPLACED_SERVERS[@]} -gt 0 ]; then
            echo "### Successful Replacements:"
            for replaced in "${REPLACED_SERVERS[@]}"; do
              echo "- $replaced"
            done
          fi
          if [ ${#FAILED_SERVERS[@]} -gt 0 ]; then
            echo ""
            echo "### Failed Servers:"
            for failed in "${FAILED_SERVERS[@]}"; do
              echo "- $failed"
            done
          fi
        } >> $GITHUB_STEP_SUMMARY
        
    - name: Commit và push thay đổi
      if: env.CHANGED == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        echo "Thay doi trong bench.sh:"
        git diff bench.sh
        
        if git diff --quiet bench.sh; then
          echo "WARNING: Khong co thay doi thuc te trong bench.sh"
          exit 0
        fi
        
        git add bench.sh
        git commit -m "Auto-update speedtest servers - $(date +'%Y-%m-%d %H:%M UTC')"
        git push
        
        echo "SUCCESS: Da commit va push thay doi thanh cong!"
