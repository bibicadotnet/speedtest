name: Speedtest Server Monitor

on:
  schedule:
    # Cháº¡y hÃ ng ngÃ y lÃºc 2:00 UTC (9:00 AM GMT+7)
    - cron: '0 2 * * *'
  workflow_dispatch: # Cho phÃ©p cháº¡y thá»§ cÃ´ng

jobs:
  check-speedtest-servers:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Install Speedtest CLI
      run: |
        # Download vÃ  cÃ i Ä‘áº·t Speedtest CLI
        curl -s https://packagecloud.io/install/repositories/ookla/speedtest-cli/script.deb.sh | sudo bash
        sudo apt-get install speedtest
        
        # Accept license
        speedtest --accept-license --accept-gdpr > /dev/null 2>&1 || true
        
    - name: Check and update server IDs
      run: |
        # Táº¡o file backup
        cp bench.sh bench.sh.backup
        
        # Danh sÃ¡ch server cáº§n check (format: "ID:Location:Country")  
        declare -A SERVERS=(
          ["68864"]="San Jose:US"
          ["62493"]="Orange France:FR" 
          ["28922"]="Amsterdam:NL"
          ["13538"]="Hong Kong:CN"
          ["7311"]="Singapore:SG"
          ["50467"]="Tokyo:JP"
          ["2515"]="FPT HCM:VN"
          ["2552"]="FPT HN:VN"
          ["17758"]="VNPT HCM:VN"
          ["17757"]="VNPT HN:VN"
          ["54812"]="Viettel HCM:VN"
          ["59915"]="Viettel DN:VN"
        )
        
        # Function Ä‘á»ƒ tÃ¬m server thay tháº¿ cÃ¹ng location
        find_replacement_server() {
          local location="$1"
          local country="$2"
          local current_id="$3"
          
          echo "ğŸ” TÃ¬m server thay tháº¿ cho $location, $country..."
          
          # Láº¥y danh sÃ¡ch server theo country
          local servers_list
          if [[ "$country" == "VN" ]]; then
            servers_list=$(speedtest --servers | grep -i "vietnam\|viet nam" | head -10)
          else
            servers_list=$(speedtest --servers | grep -i "$country" | head -10)
          fi
          
          # TÃ¬m server cÃ¹ng thÃ nh phá»‘/khu vá»±c
          local city=$(echo "$location" | cut -d' ' -f1)
          local replacement_id=$(echo "$servers_list" | grep -i "$city" | grep -v "$current_id" | head -1 | awk '{print $1}')
          
          if [[ -z "$replacement_id" ]]; then
            # Náº¿u khÃ´ng tÃ¬m tháº¥y cÃ¹ng thÃ nh phá»‘, láº¥y server khÃ¡c cÃ¹ng country
            replacement_id=$(echo "$servers_list" | grep -v "$current_id" | head -1 | awk '{print $1}')
          fi
          
          echo "$replacement_id"
        }
        
        # Biáº¿n Ä‘á»ƒ track cÃ³ thay Ä‘á»•i khÃ´ng
        CHANGED=false
        REPORT=""
        
        echo "ğŸ“Š Báº¯t Ä‘áº§u kiá»ƒm tra server speedtest..." 
        echo "======================================="
        
        for server_id in "${!SERVERS[@]}"; do
          location_info="${SERVERS[$server_id]}"
          location=$(echo "$location_info" | cut -d':' -f1)
          country=$(echo "$location_info" | cut -d':' -f2)
          
          echo "ğŸ§ª Kiá»ƒm tra Server ID: $server_id ($location, $country)"
          
          # Test server
          if timeout 30 speedtest --server-id="$server_id" --accept-license --accept-gdpr > /dev/null 2>&1; then
            echo "âœ… Server $server_id hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng"
            REPORT+="\nâœ… Server $server_id ($location, $country): OK"
          else
            echo "âŒ Server $server_id khÃ´ng pháº£n há»“i!"
            REPORT+="\nâŒ Server $server_id ($location, $country): FAILED"
            
            # TÃ¬m server thay tháº¿
            new_server_id=$(find_replacement_server "$location" "$country" "$server_id")
            
            if [[ -n "$new_server_id" && "$new_server_id" != "$server_id" ]]; then
              # Test server má»›i
              if timeout 30 speedtest --server-id="$new_server_id" --accept-license --accept-gdpr > /dev/null 2>&1; then
                echo "ğŸ”„ TÃ¬m tháº¥y server thay tháº¿: $new_server_id"
                REPORT+="\nğŸ”„ Thay tháº¿ báº±ng Server $new_server_id"
                
                # Thay tháº¿ trong file bench.sh
                sed -i "s/speed_test '$server_id'/speed_test '$new_server_id'/g" bench.sh
                sed -i "s/speed_test \"$server_id\"/speed_test \"$new_server_id\"/g" bench.sh
                
                CHANGED=true
                echo "âœ… ÄÃ£ cáº­p nháº­t Server $server_id -> $new_server_id trong bench.sh"
              else
                echo "âš ï¸  Server thay tháº¿ $new_server_id cÅ©ng khÃ´ng hoáº¡t Ä‘á»™ng"
                REPORT+="\nâš ï¸  Server thay tháº¿ $new_server_id cÅ©ng failed"
              fi
            else
              echo "âš ï¸  KhÃ´ng tÃ¬m tháº¥y server thay tháº¿ phÃ¹ há»£p"
              REPORT+="\nâš ï¸  KhÃ´ng tÃ¬m tháº¥y server thay tháº¿"
            fi
          fi
          
          echo "---"
          sleep 2
        done
        
        echo "======================================="
        echo "ğŸ“‹ BÃO CÃO Tá»”NG Káº¾T:"
        echo -e "$REPORT"
        
        # LÆ°u report vÃ o file
        echo -e "# Speedtest Server Check Report - $(date)\n$REPORT" > speedtest-report.md
        
        # Set output cho step tiáº¿p theo
        echo "CHANGED=$CHANGED" >> $GITHUB_ENV
        echo "REPORT<<EOF" >> $GITHUB_ENV
        echo -e "$REPORT" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
        
    - name: Commit changes if any
      if: env.CHANGED == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # So sÃ¡nh thay Ä‘á»•i
        echo "ğŸ“ Thay Ä‘á»•i trong bench.sh:"
        git diff bench.sh || true
        
        git add bench.sh speedtest-report.md
        git commit -m "ğŸ”„ Auto-update speedtest server IDs - $(date +'%Y-%m-%d %H:%M:%S')"
        
    - name: Push changes
      if: env.CHANGED == 'true'
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}
        
    - name: Create Issue on failures
      if: contains(env.REPORT, 'FAILED') || contains(env.REPORT, 'âš ï¸')
      uses: actions/github-script@v7
      with:
        script: |
          const report = process.env.REPORT;
          const title = `ğŸš¨ Speedtest Server Issues Detected - ${new Date().toISOString().split('T')[0]}`;
          const body = `## ğŸ“Š Speedtest Server Check Report
          
          **Thá»i gian check:** ${new Date().toLocaleString('vi-VN')}
          
          ### ğŸ“‹ Chi tiáº¿t:
          ${report}
          
          ### ğŸ”§ HÃ nh Ä‘á»™ng cáº§n thiáº¿t:
          - Kiá»ƒm tra cÃ¡c server bá»‹ lá»—i
          - Xem xÃ©t cáº­p nháº­t thá»§ cÃ´ng náº¿u cáº§n
          - Theo dÃµi hiá»‡u suáº¥t server má»›i
          
          ---
          *Issue nÃ y Ä‘Æ°á»£c táº¡o tá»± Ä‘á»™ng bá»Ÿi GitHub Action*`;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['bug', 'automated', 'speedtest']
          });
          
    - name: Upload report artifact
      uses: actions/upload-artifact@v4
      with:
        name: speedtest-report-${{ github.run_number }}
        path: speedtest-report.md
        retention-days: 30
